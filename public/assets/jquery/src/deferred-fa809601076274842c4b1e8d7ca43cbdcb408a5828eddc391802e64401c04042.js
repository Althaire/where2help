define(["./core","./var/slice","./callbacks"],function(e,t){return e.extend({Deferred:function(t){var n=[["resolve","done",e.Callbacks("once memory"),"resolved"],["reject","fail",e.Callbacks("once memory"),"rejected"],["notify","progress",e.Callbacks("memory")]],r="pending",i={state:function(){return r},always:function(){return a.done(arguments).fail(arguments),this},then:function(){var t=arguments;return e.Deferred(function(r){e.each(n,function(n,o){var s=e.isFunction(t[n])&&t[n];a[o[1]](function(){var t=s&&s.apply(this,arguments);t&&e.isFunction(t.promise)?t.promise().done(r.resolve).fail(r.reject).progress(r.notify):r[o[0]+"With"](this===i?r.promise():this,s?[t]:arguments)})}),t=null}).promise()},promise:function(t){return null!=t?e.extend(t,i):i}},a={};return i.pipe=i.then,e.each(n,function(e,t){var o=t[2],s=t[3];i[t[1]]=o.add,s&&o.add(function(){r=s},n[1^e][2].disable,n[2][2].lock),a[t[0]]=function(){return a[t[0]+"With"](this===a?i:this,arguments),this},a[t[0]+"With"]=o.fireWith}),i.promise(a),t&&t.call(a,a),a},when:function(n){var r,i,a,o=0,s=t.call(arguments),u=s.length,l=1!==u||n&&e.isFunction(n.promise)?u:0,c=1===l?n:e.Deferred(),d=function(e,n,i){return function(a){n[e]=this,i[e]=arguments.length>1?t.call(arguments):a,i===r?c.notifyWith(n,i):--l||c.resolveWith(n,i)}};if(u>1)for(r=new Array(u),i=new Array(u),a=new Array(u);u>o;o++)s[o]&&e.isFunction(s[o].promise)?s[o].promise().done(d(o,a,s)).fail(c.reject).progress(d(o,i,r)):--l;return l||c.resolveWith(a,s),c.promise()}}),e});